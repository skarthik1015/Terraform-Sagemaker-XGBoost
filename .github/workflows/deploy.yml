name: Deploy MLOps Pipeline

on:
  push:
    branches:
      - main
    
    paths:
      - 'terraform/**.tf'
      - 'terraform/**.tfvars'
      - 'ml/**.py'
      - 'lambda/**.py'
      - '.github/workflows/deploy.yml'

  workflow_dispatch:
    inputs:
      start_pipeline:
        description: 'Start SageMaker pipeline after deploy?'
        required: true
        default: 'true'
        type: choice
        options: ['true', 'false']
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options: ['dev', 'staging', 'prod']


concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

permissions:
  id-token: write
  contents: read

env:
  TF_VERSION: '1.10.0'
  PYTHON_VERSION: '3.11'
  AWS_REGION: ${{ secrets.AWS_REGION }}
  TF_DIR: 'terraform'
  ML_DIR: 'ml'

jobs:
  deploy:
    name: Terraform Apply + Start Pipeline
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}

    steps:
      # 1. Checkout
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Authenticate to AWS via OIDC
      # No AWS_ACCESS_KEY_ID or AWS_SECRET_ACCESS_KEY needed
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with: 
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: GitHubActions-Deploy-${{ github.run_number }}

      #3. Verify AWS Identity
      - name: Verify AWS Identity
        run: |
          echo "Authenticated as:"
          aws sts get-caller-identity
          echo "Region: $AWS_REGION"

      #4. Set up Python + install sagemaker SDK
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
        
      - name: Install Python dependencies
        run: pip install -r requirements.txt --quiet

      #5. Pre-generate pipeline_definitions.json
      - name: Generate pipeline definition
        env: 
          SAGEMAKER_ROLE_ARN: "arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/sagemaker-execution-role"
          S3_BUCKET: "terraform-sagemaker-firstbucket"
          MODEL_PACKAGE_GROUP: "iris-classification-models"
          PIPELINE_NAME: "iris-xgboost-pipeline-tf"
        run: |
          cd ${{ env.ML_DIR }}
          python pipeline_terraform.py
          echo "pipeline_definition.json size: $(wc -c < pipeline_definition.json) bytes"
          test -s pipeline_definition.json || (echo "ERROR: pipeline_definition.json empty" && exit 1)

      # 6. Setup Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false 

      # 7. Terraform Init
      - name: Terraform Init
        working-directory: ${{ env.TF_DIR }}
        run: terraform init -input=false

      # 8. Terraform Validate
      # Catches syntax errors before apply
      - name: Terraform Validate
        working-directory: ${{ env.TF_DIR }}
        run: terraform validate -no-color

      # 9. Terraform Apply
      # -auto-approve is safe here because PRs already ran plan + review
      - name: Terraform Apply
        id: tf_apply
        working-directory: ${{ env.TF_DIR }}
        run: |
          terraform apply \
            -auto-approve \
            -input=false \
            -var="aws_region=${{ secrets.AWS_REGION }}" \
            -var="s3_bucket_name=${{ vars.ML_S3_BUCKET }}" \
            -var="pipeline_name=${{ vars.PIPELINE_NAME }}" \
            -var="model_package_group_name=${{ vars.MODEL_PACKAGE_GROUP }}" \
            -var="sagemaker_role_name=${{ vars.SAGEMAKER_ROLE_NAME }}" \
            2>&1 | tee /tmp/tf_apply_output.txt
          echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

      # 10. Start SageMaker pipeline execution
      # Runs after successful terraform apply.
      # Skip if workflow_dispatch said not to start.
      - name: Start SageMaker pipeline
        if: |
          steps.tf_apply.outputs.exit_code == '0' &&
          (github.event_name == 'push' || github.event.inputs.start_pipeline == 'true')
        id: start_pipeline
        working-directory: ${{ env.TF_DIR }}
        run: |
          PIPELINE_NAME=$(terraform output -raw pipeline_name)
          echo "Starting pipeline: $PIPELINE_NAME"

          EXECUTION_ARN=$(aws sagemaker start-pipeline-execution \
            --pipeline-name "$PIPELINE_NAME" \
            --pipeline-execution-display-name "gitops-${{ github.sha }}" \
            --pipeline-execution-description "Triggered by commit ${{ github.sha }} on branch ${{ github.ref_name }}" \
            --query PipelineExecutionArn \
            --output text)

          echo "execution_arn=$EXECUTION_ARN" >> $GITHUB_OUTPUT
          echo "pipeline_name=$PIPELINE_NAME" >> $GITHUB_OUTPUT
          echo "Pipeline started: $EXECUTION_ARN"

      # 11. Write job summary (visible in Actions tab)
      - name: Write job summary
        if: always()
        run: |
          PIPELINE_NAME="${{ steps.start_pipeline.outputs.pipeline_name }}"
          EXECUTION_ARN="${{ steps.start_pipeline.outputs.execution_arn }}"
          REGION="${{ secrets.AWS_REGION }}"

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## MLOps Pipeline Deploy - ${{ github.run_number }}

          | Field | Value |
          |-------|-------|
          | Commit | \`${{ github.sha }}\` |
          | Branch | \`${{ github.ref_name }}\` |
          | Triggered by | ${{ github.actor }} |
          | Terraform apply | ${{ steps.tf_apply.outputs.exit_code == '0' && 'Succeeded' || 'Failed' }} |
          | Pipeline start | ${{ steps.start_pipeline.outputs.execution_arn != '' && 'Started' || 'Skipped' }} |

          ### SageMaker Pipeline
          - **Pipeline:** \`${PIPELINE_NAME}\`
          - **Execution ARN:** \`${EXECUTION_ARN}\`

          ### Console Links
          - [View Pipeline Execution](https://${REGION}.console.aws.amazon.com/sagemaker/home?region=${REGION}#/pipelines/${PIPELINE_NAME}/executions)
          - [Model Registry](https://${REGION}.console.aws.amazon.com/sagemaker/home?region=${REGION}#/model-packages/iris-classification-models)
          EOF
    